import os
from textwrap import dedent

from typing import Optional
from crewai import Agent, Task, Crew, Process, LLM
from dotenv import load_dotenv

# .envë„ ë¡œì»¬ì—ì„œ ì“¸ ìˆ˜ ìˆë„ë¡ ë¡œë“œ
load_dotenv()

# ==============================
# OpenAI ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ ì •ë¦¬ í—¬í¼
# ==============================
def _sanitize_openai_env() -> None:
    """
    OpenAI / Proxy ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ ì¤‘ì—ì„œ
    HTTP í—¤ë”ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê°’ì— í•œê¸€/ë¹„-ASCII ë¬¸ìê°€ ìˆìœ¼ë©´ ì œê±°í•œë‹¤.
    (httpxê°€ í—¤ë”ë¥¼ ASCIIë¡œë§Œ ì¸ì½”ë”©í•˜ë ¤ê³  í•´ì„œ UnicodeEncodeErrorê°€ ë‚˜ëŠ” ê²ƒì„ ë°©ì§€)
    """
    problem_vars = []

    for name, value in list(os.environ.items()):
        if not value:
            continue

        # OpenAI ê´€ë ¨ ë˜ëŠ” í”„ë¡ì‹œ ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ë§Œ ê²€ì‚¬
        if name.startswith("OPENAI") or name.endswith("_PROXY") or name in {
            "HTTP_PROXY",
            "HTTPS_PROXY",
            "ALL_PROXY",
            "NO_PROXY",
        }:
            try:
                # í—¤ë”ëŠ” ASCIIë§Œ í—ˆìš©ë˜ë¯€ë¡œ ASCII ì¸ì½”ë”©ì´ ì•ˆ ë˜ë©´ ë¬¸ì œ ìˆìŒ
                value.encode("ascii")
            except UnicodeEncodeError:
                problem_vars.append(name)

    # ë¬¸ì œ ìˆëŠ” í™˜ê²½ë³€ìˆ˜ëŠ” ì œê±°
    for name in problem_vars:
        os.environ.pop(name, None)

    # Streamlit í™˜ê²½ì´ë©´ ê²½ê³  í•œ ì¤„ ë„ì›Œì£¼ê¸° (ì–´ë–¤ ë³€ìˆ˜ ì œê±°ëëŠ”ì§€)
    if problem_vars:
        try:
            import streamlit as st

            st.warning(
                "ë‹¤ìŒ í™˜ê²½ë³€ìˆ˜ì— í•œê¸€/íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ë˜ì–´ ì œê±°í–ˆìŠµë‹ˆë‹¤. "
                "ì´ ê°’ë“¤ì´ OpenAI HTTP í—¤ë”ì— ë“¤ì–´ê°€ë©´ì„œ UnicodeEncodeErrorë¥¼ ìœ ë°œí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n"
                f"{', '.join(problem_vars)}"
            )
        except Exception:
            # streamlitì´ ì—†ëŠ” í™˜ê²½ì´ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
            pass


# ==============================
# LLM í—¬í¼
# ==============================
def _get_llm() -> LLM:
    """
    OPENAI_API_KEYë¥¼ ë‹¤ìŒ ìš°ì„ ìˆœìœ„ë¡œ ì½ì–´ì„œ CrewAI LLM ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.

    1) os.environ["OPENAI_API_KEY"]  (.env í¬í•¨)
    2) st.secrets["OPENAI_API_KEY"]  (Streamlit Cloud)
    """
    # 1) í™˜ê²½ë³€ìˆ˜ / .env
    api_key = os.getenv("OPENAI_API_KEY")

    # 2) ì•ˆ ë‚˜ì˜¤ë©´ st.secretsì—ì„œ ì‹œë„ (Streamlit í™˜ê²½ì¼ ë•Œ)
    if not api_key:
        try:
            import streamlit as st  # ìŠ¤íŠ¸ë¦¼ë¦¿ í™˜ê²½ì—ì„œë§Œ import
            api_key = st.secrets.get("OPENAI_API_KEY")
        except Exception:
            api_key = None

    # 3) ë‘˜ ë‹¤ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬
    if not api_key:
        raise RuntimeError(
            "OPENAI_API_KEYê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
            "â€¢ ë¡œì»¬: í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ .env íŒŒì¼ì— OPENAI_API_KEY=... ë¥¼ ë„£ê³ , data01.pyì—ì„œ load_dotenv()ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.\n"
            "â€¢ Streamlit: Secretsì— OPENAI_API_KEY=\"...\" ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.\n"
        )

    # ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ api_keyëŠ” ë¬´ì¡°ê±´ ì¡´ì¬
    llm = LLM(
        model="gpt-4.1-mini",   # í•„ìš”ì‹œ ì›í•˜ëŠ” ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½
        api_key=api_key,
    )
    return llm


# ==============================
# ê³µí†µ Crew ì‹¤í–‰ í•¨ìˆ˜
# ==============================
def _run_crew(prompt: str, role: str, goal: str, backstory: str) -> str:
    """
    ë‹¨ì¼ Agent + ë‹¨ì¼ Taskë¡œ ê°„ë‹¨íˆ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ê³µí†µ í•¨ìˆ˜.
    """
    # 1) LLM ìƒì„± ë‹¨ê³„ì—ì„œ ë‚˜ëŠ” RuntimeErrorë¥¼ ì¡ì•„ì„œ
    #    Streamlit í™”ë©´ì— ì—ëŸ¬ë¥¼ ë³´ì—¬ì£¼ê³ , ë¬¸ìì—´ì„ ë¦¬í„´í•˜ê²Œ ì²˜ë¦¬
    try:
        llm = _get_llm()
    except RuntimeError as e:
        # Streamlit í™˜ê²½ì´ë©´ í™”ë©´ì— ë°”ë¡œ ì—ëŸ¬ í‘œì‹œ
        try:
            import streamlit as st

            st.error(f"âŒ CrewAI LLM ì´ˆê¸°í™” ì‹¤íŒ¨\n\n{e}")
        except Exception:
            # streamlitì´ ì—†ëŠ” í™˜ê²½ì´ë©´ ì¡°ìš©íˆ íŒ¨ìŠ¤
            pass
        # ê·¸ë¦¬ê³  ë¦¬í¬íŠ¸ ìë¦¬ì—ëŠ” ì•ˆë‚´ ë¬¸êµ¬ë§Œ ë„£ì–´ ì¤Œ
        return f"âš ï¸ AI ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:\n{e}"

    # 2) LLMì´ ì •ìƒì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ê²½ìš°ì—ë§Œ Agent / Task / Crew ì‹¤í–‰
    analyst = Agent(
        role=role,
        goal=goal,
        backstory=backstory,
        verbose=False,
        allow_delegation=False,
        llm=llm,  # ğŸ‘ˆ ëª…ì‹œì ìœ¼ë¡œ LLM ì§€ì •
    )

    task = Task(
        description=prompt,
        agent=analyst,
        expected_output=(
            "í•œêµ­ì–´ë¡œ ì‘ì„±ëœ êµ¬ì¡°í™”ëœ ë¦¬í¬íŠ¸. "
            "ìš”ì•½, ì„¸ë¶€ ë¶„ì„, ê²°ë¡  ì„¹ì…˜ì„ í¬í•¨í•˜ê³ , ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•œë‹¤."
        ),
    )

    crew = Crew(
        agents=[analyst],
        tasks=[task],
        process=Process.sequential,
        verbose=False,
        llm=llm,
    )

    result = crew.kickoff()
    return str(result)


# ==============================
# 1. ì¶”ì²œ ë¦¬í¬íŠ¸
# ==============================
def run_recommendation_report(
    user_condition_text: str,
    candidates_text: str,
    extra_instruction: Optional[str] = None,
) -> str:
    """
    ì‚¬ìš©ì ì¡°ê±´(ì˜ˆ: ì˜ˆì‚°, ì§€ì—­ ì„ í˜¸, ì „ì›”ì„¸ ì¡°ê±´ ë“±)ê³¼
    í›„ë³´ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ì²œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±.
    """
    role = "ë¶€ë™ì‚° ë°ì´í„° ê¸°ë°˜ ì¶”ì²œ ì „ë¬¸ê°€"
    goal = (
        "ì‚¬ìš©ìì˜ ì¡°ê±´ê³¼ í›„ë³´ ë§¤ë¬¼ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, "
        "ê°€ì¥ ì í•©í•œ ë§¤ë¬¼ì„ ë…¼ë¦¬ì ìœ¼ë¡œ ì„ ë³„í•˜ê³  ì´ìœ ë¥¼ ì •ë¦¬í•œ ì¶”ì²œ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•œë‹¤."
    )
    backstory = (
        "ë„ˆëŠ” ì„œìš¸/ìˆ˜ë„ê¶Œ ë¶€ë™ì‚° ë°ì´í„°ë¥¼ ë‹¤ë£¨ëŠ” ë¶„ì„ê°€ë¡œì„œ, "
        "ì‚¬ìš©ìì˜ ë¼ì´í”„ìŠ¤íƒ€ì¼ê³¼ ì¡°ê±´ì„ ë°˜ì˜í•´ ë§¤ë¬¼ì„ ì¶”ì²œí•˜ê³ , "
        "ë°ì´í„°ì— ê¸°ë°˜í•œ ì´ìœ ì™€ ë¹„êµ ê·¼ê±°ë¥¼ ì œì‹œí•˜ëŠ” ì—­í• ì„ ë§¡ê³  ìˆë‹¤."
    )

    # Streamlitì—ì„œ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê¸° ì¢‹ë„ë¡ í”„ë¡¬í”„íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ êµ¬ì„±
    prompt_parts = [
        "ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ ìœ„í•œ ë§¤ë¬¼ ì¶”ì²œ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜.",
        "",
        "1) ì‚¬ìš©ì ì¡°ê±´:",
        user_condition_text,
        "",
        "2) í›„ë³´ ë§¤ë¬¼ ëª©ë¡(ìš”ì•½):",
        candidates_text,
        "",
        "ìš”êµ¬ì‚¬í•­:",
        "- ì‚¬ìš©ìì˜ í•µì‹¬ ì¡°ê±´(ì˜ˆì‚°, ìœ„ì¹˜, ì—­ì„¸ê¶Œ ì—¬ë¶€, ë©´ì  ë“±)ì„ ë¨¼ì € ì •ë¦¬í•˜ê³ ,",
        "- í›„ë³´ ë§¤ë¬¼ë“¤ì„ ê·¸ ì¡°ê±´ì— ì–¼ë§ˆë‚˜ ì˜ ë§ëŠ”ì§€ ê¸°ì¤€ìœ¼ë¡œ í‰ê°€í•´ì¤˜.",
        "- ìƒìœ„ 3ê°œ ì •ë„ì˜ ì¶”ì²œ ë§¤ë¬¼ì„ ì„ ì •í•˜ê³ , ê° ë§¤ë¬¼ë³„ ì¥ì /ë‹¨ì ê³¼ ì¶”ì²œ ì´ìœ ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜.",
        "- ë§ˆì§€ë§‰ì—ëŠ” 'ê°„ë‹¨ ìš”ì•½' ì„¹ì…˜ìœ¼ë¡œ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì¶”ì²œ ê²°ê³¼ë¥¼ ì •ë¦¬í•´ì¤˜.",
    ]

    if extra_instruction:
        prompt_parts.extend(
            [
                "",
                "ì¶”ê°€ ì§€ì‹œì‚¬í•­:",
                extra_instruction,
            ]
        )

    prompt = "\n".join(prompt_parts)

    return _run_crew(prompt, role, goal, backstory)


# ==============================
# 2. ì¡°ê±´ ì½”ì¹­ ë¦¬í¬íŠ¸
# ==============================
def run_condition_coach_report(
    user_condition_text: str,
    scenario_text: Optional[str] = None,
    extra_instruction: Optional[str] = None,
) -> str:
    """
    ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¡°ê±´(ì˜ˆì‚°, ì§€ì—­, êµ¬ì¡° ë“±)ì´ ì‹œì¥ í˜„ì‹¤ê³¼ ì–¼ë§ˆë‚˜ ë§ëŠ”ì§€,
    ì–´ë–¤ ì‹ìœ¼ë¡œ ì¡°ê±´ì„ ì¡°ì •í•˜ë©´ ì¢‹ì„ì§€ ì½”ì¹­í•´ì£¼ëŠ” ë¦¬í¬íŠ¸.

    data01.pyì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¸ì:
      - user_condition_text: í˜„ì¬ ì„ íƒëœ í•„í„°/ì¡°ê±´ ìš”ì•½
      - scenario_text: (ì„ íƒ) ì½”ë“œì—ì„œ ê³„ì‚°í•œ 'ì¡°ê±´ ì™„í™” ì‹œë‚˜ë¦¬ì˜¤' ì„¤ëª… í…ìŠ¤íŠ¸
      - extra_instruction: ì¶”ê°€ ìš”ì²­ ë¬¸êµ¬
    """
    role = "ë¶€ë™ì‚° ì¡°ê±´ ì½”ì¹˜"
    goal = (
        "ì‚¬ìš©ìê°€ ì œì‹œí•œ ì£¼ê±° ì¡°ê±´ì„ ì‹œì¥ ë°ì´í„° ê´€ì ì—ì„œ ê²€í† í•˜ê³ , "
        "í˜„ì‹¤ì ì¸ ì¡°ì • ë°©í–¥ê³¼ ìš°ì„ ìˆœìœ„ë¥¼ ì œì•ˆí•˜ëŠ” ì½”ì¹­ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•œë‹¤."
    )
    backstory = (
        "ë„ˆëŠ” ì£¼ê±° ì‹¤ìˆ˜ìš”ìë¥¼ ëŒ€ìƒìœ¼ë¡œ ì˜ˆì‚°/ì…ì§€/ë©´ì  ë“±ì˜ ì¡°ê±´ì„ í•¨ê»˜ ì¡°ìœ¨í•´ì£¼ëŠ” ì½”ì¹˜ ì—­í• ì„ ìˆ˜í–‰í•œë‹¤. "
        "ë„ˆì˜ ëª©í‘œëŠ” ì‚¬ìš©ìê°€ ì§€ë‚˜ì¹˜ê²Œ ë¹„í˜„ì‹¤ì ì¸ ì¡°ê±´ì€ ì¡°ì •í•˜ê³ , "
        "ì •ë§ ì¤‘ìš”í•œ ìš°ì„ ìˆœìœ„ë¥¼ ìŠ¤ìŠ¤ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê²ƒì´ë‹¤."
    )

    prompt_parts = [
        "ë‹¤ìŒì€ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì£¼ê±° ì¡°ê±´ì´ë‹¤:",
        "",
        user_condition_text,
        "",
        "ìœ„ ì¡°ê±´ì´ ì„œìš¸/ìˆ˜ë„ê¶Œ ì „ì›”ì„¸ ì‹œì¥ì—ì„œ ì–´ëŠ ì •ë„ í˜„ì‹¤ì ì¸ì§€ ì½”ë©˜íŠ¸í•´ì£¼ê³ ,",
        "ì•„ë˜ ë‚´ìš©ì„ í¬í•¨í•œ ì½”ì¹­ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜.",
        "",
        "- ì¡°ê±´ì˜ ì¥ì : ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ì€ ë¶€ë¶„",
        "- ì¡°ê±´ì˜ ë¦¬ìŠ¤í¬: ì‹œì¥ ìƒí™©ê³¼ ë§ì§€ ì•Šê±°ë‚˜ ë„ˆë¬´ ë¹¡ì„¼ ë¶€ë¶„",
        "- ìš°ì„ ìˆœìœ„ ì¬ì •ë¦¬ ì œì•ˆ: ê¼­ ì§€ì¼œì•¼ í•  ê²ƒ vs ìœ ì—°í•˜ê²Œ ì¡°ì • ê°€ëŠ¥í•œ ê²ƒ",
        "- ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤: ì¡°ê±´ì„ ì•½ê°„ì”© ì¡°ì •í–ˆì„ ë•Œ ê°€ëŠ¥í•œ ì„ íƒì§€ ì˜ˆì‹œ",
    ]

    if scenario_text:
        prompt_parts.extend(
            [
                "",
                "ë‹¤ìŒì€ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ëœ 'ì¡°ê±´ ì™„í™” ì‹œë‚˜ë¦¬ì˜¤' ìš”ì•½ì´ë‹¤.",
                "ì´ ë‚´ìš©ë„ ì°¸ê³ í•´ì„œ, ì‹¤ì œë¡œ ì–´ë–¤ ì‹ìœ¼ë¡œ ì¡°ê±´ì„ ì¡°ì •í•˜ë©´ ë§¤ë¬¼ì´ ëŠ˜ì–´ë‚ ì§€ ì„¤ëª…ì— ë°˜ì˜í•´ì¤˜.",
                "",
                scenario_text,
            ]
        )

    if extra_instruction:
        prompt_parts.extend(
            [
                "",
                "ì¶”ê°€ ì§€ì‹œì‚¬í•­:",
                extra_instruction,
            ]
        )

    prompt = "\n".join(prompt_parts)

    return _run_crew(prompt, role, goal, backstory)


# ==============================
# 3. ë¹„êµ ë¦¬í¬íŠ¸
# ==============================
def run_comparison_report(
    comparison_text: str,
    extra_instruction: Optional[str] = None,
) -> str:
    """
    ì§€ì—­/ìœ í˜• ë¹„êµìš© ë¦¬í¬íŠ¸.

    data01.pyì—ì„œëŠ” ì´ë¯¸ êµ¬Â·ì£¼íƒìœ í˜•ë³„ ìš”ì•½ í†µê³„ë¥¼ í•˜ë‚˜ì˜ ë¬¸ìì—´(comparison_text)ë¡œ ë§Œë“¤ì–´ì„œ ë„˜ê¸´ë‹¤.
    ì—¬ê¸°ì„œëŠ” ê·¸ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì–´ë–¤ ì§€ì—­/ìœ í˜•ì´ ì–´ë–¤ ì¸¡ë©´ì—ì„œ ìœ ë¦¬í•œì§€ í•´ì„í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
    """
    role = "ë¶€ë™ì‚° ë¹„êµ ë¶„ì„ê°€"
    goal = (
        "êµ¬Â·ì£¼íƒìœ í˜•ë³„ ìš”ì•½ í†µê³„ë¥¼ ë°”íƒ•ìœ¼ë¡œ, "
        "ì§€ì—­/ìœ í˜• ê°„ì˜ ì°¨ì´ë¥¼ ë‹¤ê°ë„ë¡œ ë¹„êµ ë¶„ì„í•˜ê³ , "
        "ìƒí™©ì— ë”°ë¼ ì–´ë–¤ ì„ íƒì´ ë” ì í•©í•œì§€ ì„¤ëª…í•˜ëŠ” ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•œë‹¤."
    )
    backstory = (
        "ë„ˆëŠ” ì£¼ê±° ì„ì°¨ ì˜ì‚¬ê²°ì •ì—ì„œ ì—¬ëŸ¬ ì§€ì—­ê³¼ ì£¼íƒìœ í˜• ì‚¬ì´ì—ì„œ ê³ ë¯¼í•˜ëŠ” ì‚¬ëŒë“¤ì„ ë„ì™€ì£¼ëŠ” ì—­í• ì„ í•œë‹¤. "
        "ê°ì •ì ì¸ í‘œí˜„ë³´ë‹¤ëŠ” ë°ì´í„°ì™€ ë…¼ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¥ë‹¨ì ì„ ë¹„êµí•˜ê³ , "
        "ê° ì¡°í•©ì´ ì í•©í•œ ìƒí™©ì„ ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ì¤˜ì•¼ í•œë‹¤."
    )

    prompt_parts = [
        "ë‹¤ìŒì€ êµ¬Â·ì£¼íƒìœ í˜•ë³„ ë³´ì¦ê¸ˆ/ì›”ì„¸/ë©´ì /ì—­ê±°ë¦¬ ë“±ì˜ ìš”ì•½ í†µê³„ì´ë‹¤.",
        "ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§€ì—­/ìœ í˜• ê°„ ì°¨ì´ë¥¼ ë¹„êµÂ·í•´ì„í•´ì¤˜.",
        "",
        "[ìš”ì•½ í†µê³„ í…Œì´ë¸”]",
        comparison_text,
        "",
        "ìš”êµ¬ì‚¬í•­:",
        "- ë³´ì¦ê¸ˆ ìˆ˜ì¤€, ì›”ì„¸ ìˆ˜ì¤€, ì „ìš©ë©´ì , ì—­ê¹Œì§€ ê±°ë¦¬ ë“±ì„ ê¸°ì¤€ìœ¼ë¡œ ì§€ì—­/ìœ í˜•ì˜ íŠ¹ì§•ì„ ì •ë¦¬í•´ì¤˜.",
        "- íŠ¹íˆ í•™ìƒ/ì‚¬íšŒì´ˆë…„ìƒ ì…ì¥ì—ì„œ ë¶€ë‹´ì´ ì ì€ ì¡°í•©ê³¼, ìƒí™œ í¸ì˜Â·ì—­ì„¸ê¶Œ ì¸¡ë©´ì—ì„œ ìœ ë¦¬í•œ ì¡°í•©ì„ êµ¬ë¶„í•´ì„œ ì„¤ëª…í•´ì¤˜.",
        "- í‘œ í˜•ì‹(í…ìŠ¤íŠ¸)ìœ¼ë¡œ 'ì§€ì—­/ìœ í˜•ë³„ í•œì¤„ ìš”ì•½'ì„ ë¨¼ì € ë³´ì—¬ì£¼ê³ ,",
        "- ê·¸ ë‹¤ìŒ ìƒì„¸ ì„¤ëª…ì„ ì„¹ì…˜ë³„ë¡œ ì •ë¦¬í•´ì¤˜.",
        "- ë§ˆì§€ë§‰ì—ëŠ” 'ì´ëŸ° ì‚¬ëŒì—ê²Œ ì¶”ì²œ' í˜•íƒœë¡œ ëª‡ ê°€ì§€ í˜ë¥´ì†Œë‚˜ë³„ ê²°ë¡ ì„ ì œì‹œí•´ì¤˜.",
    ]

    if extra_instruction:
        prompt_parts.extend(
            [
                "",
                "ì¶”ê°€ ì§€ì‹œì‚¬í•­:",
                extra_instruction,
            ]
        )

    prompt = "\n".join(prompt_parts)

    return _run_crew(prompt, role, goal, backstory)


# ==============================
# 4. í¬ì†Œì„±(ë ˆì–´ë„) ë¦¬í¬íŠ¸
# ==============================
def run_market_rarity_report(
    rarity_text: str,
    extra_instruction: Optional[str] = None,
) -> str:
    """
    í˜„ì¬ ì¡°ê±´ìœ¼ë¡œ ë‚˜ì˜¨ ë§¤ë¬¼ë“¤ì´ ì „ì²´ ì‹œì¥ì—ì„œ ì–´ëŠ ì •ë„ í¬ì†Œí•œì§€,
    'ì‹œì¥ í¬ì†Œì„±/ê²½ìŸë„' ê´€ì ì—ì„œ í•´ì„í•˜ëŠ” ë¦¬í¬íŠ¸.

    data01.pyì—ì„œëŠ” rarity_text ì•ˆì—
      - ì „ì²´ ë§¤ë¬¼ ìˆ˜
      - í˜„ì¬ ì¡°ê±´ ë§¤ë¬¼ ìˆ˜
      - ë¹„ì¤‘(%)
      - ì£¼ìš” ë³€ìˆ˜(ë³´ì¦ê¸ˆ/ì›”ì„¸/ë©´ì /ì—­ê±°ë¦¬)ì˜ ì „ì²´ vs í˜„ì¬ ì¡°ê±´ í‰ê·  ë¹„êµ
    ë¥¼ ë¯¸ë¦¬ ì •ë¦¬í•´ì„œ ë„˜ê¸´ë‹¤.
    """
    role = "ë¶€ë™ì‚° í¬ì†Œì„± ë¶„ì„ê°€"
    goal = (
        "í˜„ì¬ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§ëœ ë§¤ë¬¼ë“¤ì˜ í¬ì†Œì„±ê³¼ ì‹œì¥ ë‚´ ê²½ìŸë„ë¥¼ í•´ì„í•˜ê³ , "
        "ì„ì°¨ì¸ì˜ í˜‘ìƒë ¥Â·ëŒ€ì²´ ê°€ëŠ¥ì„±Â·í–¥í›„ ê³µê¸‰/ìˆ˜ìš” ë¦¬ìŠ¤í¬ë¥¼ ì •ë¦¬í•œ ë¸Œë¦¬í•‘ì„ ì‘ì„±í•œë‹¤."
    )
    backstory = (
        "ë„ˆëŠ” ì—¬ëŸ¬ ë§¤ë¬¼ ì¤‘ì—ì„œ 'ë†“ì¹˜ë©´ ë‹¤ì‹œ ë‚˜ì˜¤ê¸° ì–´ë ¤ìš´ íƒ€ì…'ì¸ì§€, "
        "ì•„ë‹ˆë©´ ë¹„ìŠ·í•œ ëŒ€ì²´ì¬ê°€ ë§ì€ í‰ë²”í•œ ë§¤ë¬¼ì¸ì§€ êµ¬ë¶„í•´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤. "
        "íŠ¹íˆ ê³µê¸‰ëŸ‰ì´ ì ì€ íƒ€ì…, íŠ¹ì • ì—­ì„¸ê¶Œ ë¼ì¸, êµ¬ì¡°/ë©´ì  ì¡°í•© ë“± í¬ì†Œì„±ì„ ì˜ ì§šì–´ì¤˜ì•¼ í•œë‹¤."
    )

    prompt_parts = [
        "ë‹¤ìŒì€ íŠ¹ì • ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§í•œ ì „ì›”ì„¸ ë§¤ë¬¼ì˜ ì‹œì¥ ë‚´ í¬ì†Œì„± ê´€ë ¨ ê¸°ì´ˆ ì •ë³´ì´ë‹¤.",
        "",
        rarity_text,
        "",
        "ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ ë‚´ìš©ì„ í¬í•¨í•œ 'ì‹œì¥ í¬ì†Œì„±/ê²½ìŸë„ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì¤˜.",
        "",
        "- í˜„ì¬ ì¡°ê±´ì´ ì „ì²´ ì‹œì¥ì—ì„œ ì°¨ì§€í•˜ëŠ” ë¹„ì¤‘ê³¼ ê·¸ ì˜ë¯¸",
        "- ê°€ê²©(ë³´ì¦ê¸ˆ/ì›”ì„¸) ì¸¡ë©´ì—ì„œ ì „ì²´ ëŒ€ë¹„ ì–´ëŠ ì •ë„ ìˆ˜ì¤€ì¸ì§€",
        "- ì „ìš©ë©´ì , ì—­ê±°ë¦¬ ë“± êµ¬ì¡°Â·ì…ì§€ íŠ¹ì„±ì˜ í¬ì†Œì„± ì—¬ë¶€",
        "- ì„ì°¨ì¸ì˜ í˜‘ìƒë ¥: ê³µê¸‰ì´ ë§ì€ì§€/ì ì€ì§€, ëŒ€ì²´ì¬ ìœ ë¬´",
        "- í–¥í›„ 1~2ë…„ ë‚´ ìˆ˜ê¸‰ ë³€ë™(ì˜ˆ: ì…ì£¼ ë¬¼ëŸ‰, ì •ì±… ë³€í™” ë“±)ì„ ê°€ì •í•œ ë¦¬ìŠ¤í¬/ê¸°íšŒ ìš”ì•½",
    ]

    if extra_instruction:
        prompt_parts.extend(
            [
                "",
                "ì¶”ê°€ ì§€ì‹œì‚¬í•­:",
                extra_instruction,
            ]
        )

    prompt = "\n".join(prompt_parts)

    return _run_crew(prompt, role, goal, backstory)

def run_listing_judgement_report(
    listing_text: str,
    extra_instruction: Optional[str] = None,
) -> str:
    role = "ë¶€ë™ì‚° ë§¤ë¬¼ í‰ê°€ ì „ë¬¸ê°€"
    goal = "ì‹¤ì œ ë³¸ ë§¤ë¬¼ì´ ì‹œì¥ì—ì„œ ì¢‹ì€ ì„ íƒì¸ì§€ íŒë‹¨í•˜ê³ , ê·¼ê±°ë¥¼ ì„¤ëª…í•œë‹¤."
    backstory = (
        "ë„ˆëŠ” ì‹¤ê±°ë˜ ë°ì´í„°ì™€ ê°€ê²© ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ, "
        "ê°œë³„ ë§¤ë¬¼ì´ í•©ë¦¬ì ì¸ ì„ íƒì¸ì§€ ì¡°ì–¸í•˜ëŠ” ë¶„ì„ê°€ë‹¤."
    )

    prompt_parts = [
        "ë‹¤ìŒì€ ì‹¤ì œ ë³¸ ë§¤ë¬¼ì˜ ì‹œì¥ ë¹„êµ ê²°ê³¼ì´ë‹¤.",
        "",
        listing_text,
        "",
        "ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ë¥¼ í¬í•¨í•´ í‰ê°€ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜.",
        "- ì´ ë§¤ë¬¼ì´ ì™œ ì¢‹ì€ì§€/ì™œ ì• ë§¤í•œì§€/ì™œ í”¼í•´ì•¼ í•˜ëŠ”ì§€",
        "- ìˆ«ì ê·¼ê±°ë¥¼ ë§ë¡œ í’€ì–´ì„œ ì„¤ëª…",
        "- ê³„ì•½ ì „ì— ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  ì²´í¬í¬ì¸íŠ¸",
        "- ë§ˆì§€ë§‰ì— í•œ ì¤„ ê²°ë¡ ",
    ]

    if extra_instruction:
        prompt_parts.extend(["", "ì¶”ê°€ ì§€ì‹œì‚¬í•­:", extra_instruction])

    prompt = "\n".join(prompt_parts)
    return _run_crew(prompt, role, goal, backstory)


__all__ = [
    "run_recommendation_report",
    "run_condition_coach_report",
    "run_comparison_report",
    "run_market_rarity_report",
    "run_listing_judgement_report",
]
